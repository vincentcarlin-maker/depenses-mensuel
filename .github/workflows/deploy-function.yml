name: Déployer la Fonction Supabase

on:
  push:
    branches:
      - main
    # Déployer uniquement si des changements ont lieu dans le dossier des fonctions
    paths:
      - 'supabase/functions/**'
  workflow_dispatch:

# =============================================================================
# ACTION REQUISE : Configuration des Secrets sur GitHub
# =============================================================================
# Pour que ce déploiement fonctionne, vous DEVEZ configurer les "secrets"
# suivants dans les paramètres de votre dépôt GitHub.
#
# 1. Allez sur votre dépôt GitHub > Settings > Secrets and variables > Actions.
# 2. Cliquez sur "New repository secret" pour chaque secret ci-dessous.
#
# SECRETS REQUIS :
#
#   - NOM : SUPABASE_PROJECT_ID
#   - VALEUR : L'identifiant de votre projet Supabase. Vous le trouverez dans
#     votre tableau de bord Supabase > Settings > General > Project ID.
#
#   - NOM : SUPABASE_ACCESS_TOKEN
#   - VALEUR : Un jeton d'accès personnel. Pour en créer un :
#       a. Allez sur https://supabase.com/dashboard/account/tokens
#       b. Cliquez sur "Generate New Token".
#       c. Donnez-lui un nom (ex: "GitHub Actions Deploy") et cliquez sur "Generate token".
#       d. Copiez la valeur générée et collez-la ici.
#
# =============================================================================

jobs:
  deploy_function:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Installation des dépendances
        run: npm install

      - name: Déployer la fonction Edge sur Supabase
        # Utilisation de 'npx' pour exécuter la CLI Supabase.
        # Après `npm install`, la commande sera trouvée dans node_modules.
        run: npx supabase functions deploy send-notification --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --no-verify-jwt
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
